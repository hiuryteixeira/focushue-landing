<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agenda Integrada - FocusHue</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#81C784">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="FocusHue">
  <meta name="msapplication-TileColor" content="#81C784">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-192x192.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Variáveis CSS padronizadas do FocusHue */
    :root {
      --estudo: #6BAED6;
      --foco: #81C784;
      --descanso: #F4E06D;
      --alerta: #EF9A9A;
      --bg: #d7e3da;
      --text: #2e2e2e;
      --bg-dark: #1c1c1c;
      --text-dark: #eeeeee;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
    }

    body.dark {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    /* Header padronizado */
    header {
      background: linear-gradient(to right, var(--foco), var(--estudo));
      padding: 20px;
      color: white;
      text-align: center;
      font-size: 1.6rem;
      font-weight: 600;
      position: relative;
    }

    .menu-toggle, .theme-toggle {
      position: absolute;
      top: 20px;
      font-size: 1.4rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .menu-toggle { left: 20px; }
    .theme-toggle { right: 20px; }

    .menu-toggle:hover, .theme-toggle:hover {
      opacity: 0.8;
    }

    /* Menu de navegação padronizado */
    nav {
      display: none;
      flex-direction: column;
      background: rgba(255,255,255,0.95);
      position: absolute;
      top: 70px;
      left: 10px;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
      min-width: 200px;
    }

    body.dark nav {
      background: rgba(40,40,40,0.95);
    }

    nav a {
      padding: 10px 15px;
      text-decoration: none;
      color: #333;
      font-weight: 500;
      border-radius: 5px;
      transition: background-color 0.3s, color 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    body.dark nav a {
      color: #eee;
    }

    nav a:hover {
      background: var(--foco);
      color: white;
    }

    /* Container da agenda */
    .agenda-container {
      max-width: 800px;
      margin: 30px auto;
      padding: 0 20px;
    }

    /* Estilos dos blocos */
    .bloco {
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 18px;
      color: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .bloco::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: rgba(255,255,255,0.3);
    }

    .bloco.active {
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        border: 2px solid rgba(255,255,255,0.5);
    }

    .bloco-header {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .bloco-body {
        padding-top: 12px;
        margin-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.2);
    }

    .bloco-body h4 { 
      margin: 0 0 10px 0; 
      font-size: 0.95rem; 
      font-weight: 600;
    }

    .bloco-body ul { 
      margin: 0; 
      padding-left: 20px; 
      font-size: 0.9rem; 
      line-height: 1.4;
    }

    .bloco-body li {
      margin-bottom: 4px;
    }

    /* Controles dos blocos */
    select, input[type="time"] {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.3);
      font-weight: 600;
      font-size: 0.9rem;
      background: rgba(255,255,255,0.1);
      color: white;
      font-family: 'Inter', sans-serif;
    }

    select:focus, input[type="time"]:focus {
      outline: none;
      border-color: rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.2);
    }

    body.dark select, body.dark input[type="time"] {
      background: rgba(0,0,0,0.2);
      border-color: rgba(255,255,255,0.2);
    }

    .bloco button {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .bloco .main-controls { 
      margin-left: auto; 
      display: flex; 
      gap: 8px; 
      flex-shrink: 0;
    }

    .bloco button:hover { 
      background: rgba(255,255,255,0.4); 
      transform: translateY(-1px);
    }

    /* Cores dos blocos */
    .estudo { background: linear-gradient(135deg, var(--estudo), #5a9bd4); }
    .foco { background: linear-gradient(135deg, var(--foco), #6bb76e); }
    .descanso { 
      background: linear-gradient(135deg, var(--descanso), #f0d84a); 
      color: var(--text); 
    }
    .descanso button { 
      color: var(--text); 
      background: rgba(0,0,0,0.1); 
    }
    .descanso button:hover { 
      background: rgba(0,0,0,0.2); 
    }
    .descanso select, .descanso input[type="time"] {
      color: var(--text);
      background: rgba(0,0,0,0.1);
      border-color: rgba(0,0,0,0.2);
    }
    .alerta { background: linear-gradient(135deg, var(--alerta), #e57373); }

    /* Botão adicionar */
    .add-btn {
      margin: 30px auto 20px;
      padding: 14px 28px;
      font-size: 1rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--foco), var(--estudo));
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
      display: block;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .add-btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    /* Seção de personalização */
    .customize {
      text-align: center;
      margin: 40px auto;
      padding: 20px;
    }

    .customize-btn {
      margin: 5px;
      padding: 12px 20px;
      border: none;
      background: linear-gradient(135deg, #666, #888);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .customize-btn:hover {
      background: linear-gradient(135deg, var(--foco), var(--estudo));
      transform: translateY(-1px);
    }

    /* Mensagem de login */
    #mensagemLogin {
        text-align: center;
        margin: 50px auto;
        padding: 40px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        max-width: 500px;
    }

    body.dark #mensagemLogin {
      background: #2e2e2e;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    #mensagemLogin h3 {
      margin-bottom: 15px;
      color: var(--text);
    }

    body.dark #mensagemLogin h3 {
      color: var(--text-dark);
    }

    #mensagemLogin p {
      margin-bottom: 20px;
      color: var(--text);
      opacity: 0.8;
    }

    body.dark #mensagemLogin p {
      color: var(--text-dark);
    }

    #mensagemLogin a { 
      color: var(--estudo); 
      font-weight: 600; 
      text-decoration: none;
      margin: 0 10px;
      padding: 10px 20px;
      border-radius: 6px;
      background: rgba(107, 174, 214, 0.1);
      transition: all 0.3s;
    }

    #mensagemLogin a:hover {
      background: var(--estudo);
      color: white;
      transform: translateY(-1px);
    }

    body.dark #mensagemLogin a { 
      color: var(--foco); 
      background: rgba(129, 199, 132, 0.1);
    }

    body.dark #mensagemLogin a:hover {
      background: var(--foco);
    }

    /* Modais */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 200; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.6); 
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background-color: var(--bg);
        margin: 8% auto; 
        padding: 30px;
        border: none;
        width: 90%; 
        max-width: 500px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        color: var(--text);
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dark .modal-content { 
      background-color: #2c2c2c; 
      color: var(--text-dark); 
    }

    .modal-content h3 {
      margin-bottom: 20px;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .modal-buttons {
        text-align: right;
        margin-top: 25px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .modal-buttons button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-family: 'Inter', sans-serif;
    }

    .save-btn { 
      background-color: var(--foco); 
      color: white; 
    }

    .save-btn:hover {
      background-color: #6bb76e;
      transform: translateY(-1px);
    }

    .cancel-btn { 
      background-color: #ccc; 
      color: #333; 
    }

    .cancel-btn:hover {
      background-color: #bbb;
    }

    .dark .cancel-btn { 
      background-color: #555; 
      color: var(--text-dark); 
    }

    .dark .cancel-btn:hover {
      background-color: #666;
    }

    /* Lista de tarefas no modal */
    #listaTarefasModal {
      max-height: 250px; 
      overflow-y: auto; 
      padding: 15px; 
      border: 1px solid #ddd; 
      border-radius: 8px;
      background: rgba(0,0,0,0.02);
    }

    .dark #listaTarefasModal {
      border-color: #555;
      background: rgba(255,255,255,0.02);
    }

    #listaTarefasModal .tarefa-item { 
      display: flex;
      align-items: center;
      margin-bottom: 12px; 
      padding: 8px;
      border-radius: 6px;
      transition: background-color 0.3s;
    }

    #listaTarefasModal .tarefa-item:hover {
      background: rgba(0,0,0,0.05);
    }

    .dark #listaTarefasModal .tarefa-item:hover {
      background: rgba(255,255,255,0.05);
    }

    #listaTarefasModal input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }

    #listaTarefasModal label { 
      margin-left: 0;
      cursor: pointer;
      flex: 1;
    }

    /* Notificações */
    .notification-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--foco);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 1000;
      animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 30px 20px;
      font-size: 0.9rem;
      color: #999;
      border-top: 1px solid rgba(0,0,0,0.1);
      margin-top: 60px;
    }

    body.dark footer {
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .agenda-container {
        padding: 0 15px;
      }

      .bloco-header {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .bloco .main-controls {
        margin-left: 0;
        justify-content: center;
        order: -1;
      }

      .modal-content {
        width: 95%;
        padding: 20px;
        margin: 15% auto;
      }

      .modal-buttons {
        flex-direction: column;
      }

      .modal-buttons button {
        width: 100%;
        margin-bottom: 10px;
      }

      select, input[type="time"] {
        width: 100%;
        margin-bottom: 8px;
      }
    }

    /* Animações de entrada */
    .bloco {
      animation: fadeInUp 0.5s ease-out;
    }

    .bloco:nth-child(2) { animation-delay: 0.1s; }
    .bloco:nth-child(3) { animation-delay: 0.2s; }
    .bloco:nth-child(4) { animation-delay: 0.3s; }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

  </style>
</head>
<body>


<!-- Conteúdo principal da agenda -->
<section class="agenda-container" id="agendaContainer">
  <div id="blocosDia"></div>
  <button class="add-btn" onclick="adicionarBloco()">+ Adicionar Bloco</button>
</section>

<!-- Mensagem para usuário não logado -->
<div id="mensagemLogin" style="display: none;">
  <h3>🔐 Acesso Restrito</h3>
  <p>Você precisa estar logado para ver e editar sua agenda personalizada.</p>
  <div>
    <a href="login.html">Fazer Login</a>
    <a href="cadastro.html">Criar Conta</a>
  </div>
</div>

<!-- Seção de personalização -->
<div class="customize">
  <button class="customize-btn" onclick="abrirModalCores()">
    🎨 Personalizar Cores
    <span style="display: inline-flex; gap: 3px; margin-left: 5px;">
      <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--foco);"></span>
      <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--estudo);"></span>
      <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--descanso);"></span>
      <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--alerta);"></span>
    </span>
  </button>
</div>

<!-- Modal para associar tarefas -->
<div id="modalAssociarTarefa" class="modal">
  <div class="modal-content">
    <h3>🔗 Associar Tarefas ao Bloco</h3>
    <p>Selecione as tarefas que você deseja associar a este bloco:</p>
    <input type="hidden" id="blocoIdParaAssociar">
    <div id="listaTarefasModal">
      <!-- Lista de tarefas será carregada aqui -->
    </div>
    <div class="modal-buttons">
      <button class="cancel-btn" onclick="fecharModalAssociar()">Cancelar</button>
      <button class="save-btn" onclick="salvarAssociacaoTarefas()">Salvar Associações</button>
    </div>
  </div>
</div>

<!-- Modal de notificação interativa -->
<div id="modalNotificacao" class="modal">
  <div class="modal-content">
    <h3 id="notificacaoTitulo">🔔 Hora de Começar!</h3>
    <p id="notificacaoMensagem"></p>
    <div id="notificacaoTarefas"></div>
    <div class="modal-buttons">
      <button class="cancel-btn" onclick="fecharNotificacao()">Agora não</button>
      <button class="save-btn" id="btnConfirmarBloco">Confirmar e Iniciar</button>
    </div>
  </div>
</div>

<!-- Modal de personalização de cores -->
<div id="modalCores" class="modal">
  <div class="modal-content">
    <h3>🎨 Personalizar Cores dos Blocos</h3>
    <p>Escolha as cores para cada tipo de atividade:</p>
    
    <div style="display: grid; gap: 15px; margin: 20px 0;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <label for="corFoco" style="min-width: 80px; font-weight: 500;">🎯 Foco:</label>
        <input type="color" id="corFoco" value="#81C784" style="width: 50px; height: 35px; border: none; border-radius: 6px; cursor: pointer;">
        <span id="previewFoco" style="flex: 1; padding: 8px 12px; border-radius: 6px; color: white; font-weight: 500;">Exemplo</span>
      </div>
      
      <div style="display: flex; align-items: center; gap: 10px;">
        <label for="corEstudo" style="min-width: 80px; font-weight: 500;">📚 Estudo:</label>
        <input type="color" id="corEstudo" value="#6BAED6" style="width: 50px; height: 35px; border: none; border-radius: 6px; cursor: pointer;">
        <span id="previewEstudo" style="flex: 1; padding: 8px 12px; border-radius: 6px; color: white; font-weight: 500;">Exemplo</span>
      </div>
      
      <div style="display: flex; align-items: center; gap: 10px;">
        <label for="corDescanso" style="min-width: 80px; font-weight: 500;">😌 Descanso:</label>
        <input type="color" id="corDescanso" value="#F4E06D" style="width: 50px; height: 35px; border: none; border-radius: 6px; cursor: pointer;">
        <span id="previewDescanso" style="flex: 1; padding: 8px 12px; border-radius: 6px; color: #2e2e2e; font-weight: 500;">Exemplo</span>
      </div>
      
      <div style="display: flex; align-items: center; gap: 10px;">
        <label for="corAlerta" style="min-width: 80px; font-weight: 500;">⚠️ Alerta:</label>
        <input type="color" id="corAlerta" value="#EF9A9A" style="width: 50px; height: 35px; border: none; border-radius: 6px; cursor: pointer;">
        <span id="previewAlerta" style="flex: 1; padding: 8px 12px; border-radius: 6px; color: white; font-weight: 500;">Exemplo</span>
      </div>
    </div>
    
    <div class="modal-buttons">
      <button class="cancel-btn" onclick="restaurarCoresPadrao()">Restaurar Padrão</button>
      <button class="cancel-btn" onclick="fecharModalCores()">Fechar</button>
    </div>
  </div>
</div>

<footer>
  © 2025 FocusHue™ — Sistema Cromático de Foco.
</footer>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="menu.js"></script>

<script>
  // Configuração Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyC60NDS13uLBH1Az1EW9sY3eEL8BF80Bxc",
    authDomain: "focushue-16683.firebaseapp.com",
    projectId: "focushue-16683",
    storageBucket: "focushue-16683.appspot.com",
    messagingSenderId: "485935414293",
    appId: "1:485935414293:web:c7ead918246319e0d6a21c"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;
  let agendaIntervalo;
  let blocosAnteriores = [];

  function carregarCoresSalvas() {
    // Carrega cores personalizadas
    ["--estudo", "--foco", "--descanso", "--alerta"].forEach(variable => {
      const corSalva = localStorage.getItem(variable);
      if (corSalva) {
        document.documentElement.style.setProperty(variable, corSalva);
      }
    });
  }

  // --- Funções da Agenda ---
  function adicionarBloco(tipo = "foco", inicio = "09:00", fim = "10:00", tarefaIds = [], id = null) {
    const blocoId = id || `bloco_${Date.now()}`;
    const div = document.createElement("div");
    div.className = `bloco ${tipo}`;
    div.dataset.id = blocoId;
    div.dataset.tarefaIds = JSON.stringify(tarefaIds);

    div.innerHTML = `
      <div class="bloco-header">
        <select onchange="this.parentElement.parentElement.className='bloco ' + this.value; salvarAgenda();" aria-label="Tipo do bloco">
          <option value="foco" ${tipo === "foco" ? "selected" : ""}>🎯 Foco</option>
          <option value="estudo" ${tipo === "estudo" ? "selected" : ""}>📚 Estudo</option>
          <option value="descanso" ${tipo === "descanso" ? "selected" : ""}>😌 Descanso</option>
          <option value="alerta" ${tipo === "alerta" ? "selected" : ""}>⚠️ Alerta</option>
        </select>
        <input type="time" class="inicio" value="${inicio}" onchange="salvarAgenda()" aria-label="Horário de início">
        <span>até</span>
        <input type="time" class="fim" value="${fim}" onchange="salvarAgenda()" aria-label="Horário de fim">
        <div class="main-controls">
            <button onclick="abrirModalAssociar('${blocoId}')" title="Associar tarefas" aria-label="Associar tarefas">🔗</button>
            <button onclick="removerBloco(this.parentElement.parentElement.parentElement)" title="Remover bloco" aria-label="Remover bloco">🗑️</button>
        </div>
      </div>
      <div class="bloco-body" id="tarefas-${blocoId}"></div>
    `;
    
    document.getElementById('blocosDia').appendChild(div);
    salvarAgenda();
    carregarTarefasDoBloco(blocoId, tarefaIds);
    
    // Adiciona animação de entrada
    setTimeout(() => {
      div.style.opacity = '0';
      div.style.transform = 'translateY(20px)';
      div.style.transition = 'all 0.3s ease';
      setTimeout(() => {
        div.style.opacity = '1';
        div.style.transform = 'translateY(0)';
      }, 10);
    }, 10);
  }

  async function salvarAgenda() {
    if (!currentUser) return;
    
    try {
      const blocos = [...document.querySelectorAll(".bloco")].map(b => ({
        id: b.dataset.id,
        tipo: b.querySelector("select").value,
        inicio: b.querySelector(".inicio").value,
        fim: b.querySelector(".fim").value,
        tarefaIds: JSON.parse(b.dataset.tarefaIds || '[]')
      }));
      
      await db.collection("users").doc(currentUser.uid).collection("agenda").doc("dia").set({ blocos });
      
      // Atualiza estatísticas se houve mudanças
      await atualizarEstatisticas(blocos);
      
      // Mostra notificação de sucesso
      mostrarNotificacaoSucesso("Agenda salva!");
      
    } catch (error) {
      console.error("Erro ao salvar agenda:", error);
      mostrarNotificacaoErro("Erro ao salvar agenda. Tente novamente.");
    }
  }

  async function carregarAgenda() {
    if (!currentUser) return;
    
    try {
      const doc = await db.collection("users").doc(currentUser.uid).collection("agenda").doc("dia").get();
      const container = document.getElementById('blocosDia');
      
      if (doc.exists) {
        container.innerHTML = '';
        const blocos = doc.data().blocos || [];
        blocos.forEach(b => adicionarBloco(b.tipo, b.inicio, b.fim, b.tarefaIds, b.id));
        blocosAnteriores = [...blocos];
      } else {
        // Adiciona bloco padrão se não houver agenda
        container.innerHTML = '';
        adicionarBloco();
      }
      
    } catch (error) {
      console.error("Erro ao carregar agenda:", error);
      mostrarNotificacaoErro("Erro ao carregar agenda.");
    }
  }

  function removerBloco(elemento) {
    if (confirm("Tem certeza que deseja remover este bloco?")) {
      elemento.style.transition = 'all 0.3s ease';
      elemento.style.opacity = '0';
      elemento.style.transform = 'translateX(-100px)';
      
      setTimeout(() => {
        elemento.remove();
        salvarAgenda();
      }, 300);
    }
  }

  // --- Funções de Associação de Tarefas ---
  async function abrirModalAssociar(blocoId) {
    try {
      document.getElementById('blocoIdParaAssociar').value = blocoId;
      const tarefasSnapshot = await db.collection("users").doc(currentUser.uid).collection("tarefas").get();
      const listaTarefasModal = document.getElementById('listaTarefasModal');
      
      if (tarefasSnapshot.empty) {
        listaTarefasModal.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">Nenhuma tarefa encontrada. <a href="tarefas.html" style="color: var(--foco);">Crie suas primeiras tarefas</a></p>';
      } else {
        listaTarefasModal.innerHTML = '';
        const bloco = document.querySelector(`.bloco[data-id='${blocoId}']`);
        const tarefaIdsAssociadas = JSON.parse(bloco.dataset.tarefaIds || '[]');

        tarefasSnapshot.forEach(doc => {
          const tarefa = { id: doc.id, ...doc.data() };
          const isChecked = tarefaIdsAssociadas.includes(tarefa.id) ? 'checked' : '';
          
          const tarefaDiv = document.createElement('div');
          tarefaDiv.className = 'tarefa-item';
          tarefaDiv.innerHTML = `
            <input type="checkbox" id="${tarefa.id}" value="${tarefa.id}" ${isChecked}>
            <label for="${tarefa.id}">${tarefa.titulo}</label>
          `;
          listaTarefasModal.appendChild(tarefaDiv);
        });
      }
      
      // Aplica tema escuro ao modal se necessário
      const modalContent = document.querySelector("#modalAssociarTarefa .modal-content");
      if (document.body.classList.contains("dark")) {
        modalContent.classList.add("dark");
      } else {
        modalContent.classList.remove("dark");
      }
      
      document.getElementById('modalAssociarTarefa').style.display = 'block';
      
    } catch (error) {
      console.error("Erro ao carregar tarefas:", error);
      mostrarNotificacaoErro("Erro ao carregar tarefas.");
    }
  }

  function fecharModalAssociar() {
    document.getElementById('modalAssociarTarefa').style.display = 'none';
  }

  function salvarAssociacaoTarefas() {
    const blocoId = document.getElementById('blocoIdParaAssociar').value;
    const bloco = document.querySelector(`.bloco[data-id='${blocoId}']`);
    const tarefaIds = [...document.querySelectorAll('#listaTarefasModal input:checked')].map(input => input.value);
    
    bloco.dataset.tarefaIds = JSON.stringify(tarefaIds);
    salvarAgenda();
    carregarTarefasDoBloco(blocoId, tarefaIds);
    fecharModalAssociar();
    
    mostrarNotificacaoSucesso(`${tarefaIds.length} tarefa(s) associada(s) ao bloco!`);
  }

  async function carregarTarefasDoBloco(blocoId, tarefaIds) {
    const container = document.getElementById(`tarefas-${blocoId}`);
    
    if (!tarefaIds || tarefaIds.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    try {
      container.innerHTML = '<h4>📋 Tarefas Associadas:</h4><ul>';
      
      for (const tarefaId of tarefaIds) {
          const tarefaDoc = await db.collection("users").doc(currentUser.uid).collection("tarefas").doc(tarefaId).get();
          if (tarefaDoc.exists) {
              const li = document.createElement('li');
              li.textContent = tarefaDoc.data().titulo;
              container.querySelector('ul').appendChild(li);
          }
      }
      
      container.innerHTML += '</ul>';
      
    } catch (error) {
      console.error("Erro ao carregar tarefas do bloco:", error);
      container.innerHTML = '<p style="color: #999; font-size: 0.9rem;">Erro ao carregar tarefas</p>';
    }
  }

  // --- Notificações Interativas ---
  function verificarAgenda() {
    const agora = new Date();
    const horaAtual = agora.getHours().toString().padStart(2, '0');
    const minutoAtual = agora.getMinutes().toString().padStart(2, '0');
    const tempoAtual = `${horaAtual}:${minutoAtual}`;

    document.querySelectorAll('.bloco').forEach(blocoEl => {
      const inicio = blocoEl.querySelector('.inicio').value;
      if (inicio === tempoAtual && !blocoEl.dataset.notificado) {
        blocoEl.dataset.notificado = 'true';
        const tipo = blocoEl.querySelector('select').value;
        const blocoId = blocoEl.dataset.id;
        mostrarNotificacao(blocoId, tipo);
      }
    });
  }

  async function mostrarNotificacao(blocoId, tipo) {
    const modal = document.getElementById('modalNotificacao');
    const titulo = document.getElementById('notificacaoTitulo');
    const mensagem = document.getElementById('notificacaoMensagem');
    const tarefasDiv = document.getElementById('notificacaoTarefas');
    const btnConfirmar = document.getElementById('btnConfirmarBloco');
    
    titulo.textContent = `🔔 Hora de ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}!`;
    mensagem.textContent = `Já vai iniciar seu período de ${tipo}?`;
    
    // Carrega tarefas associadas
    const bloco = document.querySelector(`.bloco[data-id='${blocoId}']`);
    const tarefaIds = JSON.parse(bloco.dataset.tarefaIds || '[]');
    
    if (tarefaIds.length > 0) {
      tarefasDiv.innerHTML = '<h4>📋 Tarefas para este período:</h4><ul>';
      
      try {
        for (const tarefaId of tarefaIds) {
          const tarefaDoc = await db.collection("users").doc(currentUser.uid).collection("tarefas").doc(tarefaId).get();
          if (tarefaDoc.exists) {
            const li = document.createElement('li');
            li.textContent = tarefaDoc.data().titulo;
            li.style.marginBottom = '5px';
            tarefasDiv.querySelector('ul').appendChild(li);
          }
        }
        tarefasDiv.innerHTML += '</ul>';
      } catch (error) {
        console.error("Erro ao carregar tarefas da notificação:", error);
        tarefasDiv.innerHTML = '<p style="color: #999;">Erro ao carregar tarefas</p>';
      }
    } else {
      tarefasDiv.innerHTML = '<p style="color: #999; font-style: italic;">Nenhuma tarefa associada a este bloco.</p>';
    }
    
    btnConfirmar.onclick = () => confirmarInicioBloco(blocoId, tipo);
    
    // Aplica tema ao modal
    const modalContent = modal.querySelector('.modal-content');
    if (document.body.classList.contains("dark")) {
      modalContent.classList.add("dark");
    } else {
      modalContent.classList.remove("dark");
    }
    
    modal.style.display = 'block';
  }

  function fecharNotificacao() {
    document.getElementById('modalNotificacao').style.display = 'none';
  }

  async function confirmarInicioBloco(blocoId, tipo) {
    try {
      // Marca o bloco como ativo
      const bloco = document.querySelector(`.bloco[data-id='${blocoId}']`);
      document.querySelectorAll('.bloco').forEach(b => b.classList.remove('active'));
      bloco.classList.add('active');
      
      // Registra nas estatísticas
      await registrarAtividadeEstatisticas(tipo);
      
      fecharNotificacao();
      mostrarNotificacaoSucesso(`Período de ${tipo} iniciado! Mantenha o foco.`);
      
    } catch (error) {
      console.error("Erro ao confirmar início do bloco:", error);
      mostrarNotificacaoErro("Erro ao registrar atividade.");
    }
  }

  // --- Funções de Estatísticas ---
  async function atualizarEstatisticas(blocosAtuais) {
    if (!currentUser) return;
    
    try {
      // Compara com blocos anteriores para detectar mudanças
      const blocosAdicionados = blocosAtuais.filter(atual => 
        !blocosAnteriores.find(anterior => anterior.id === atual.id)
      );
      
      const blocosRemovidos = blocosAnteriores.filter(anterior => 
        !blocosAtuais.find(atual => atual.id === anterior.id)
      );
      
      // Atualiza contadores
      for (const bloco of blocosAdicionados) {
        await incrementarEstatistica(bloco.tipo);
      }
      
      for (const bloco of blocosRemovidos) {
        await decrementarEstatistica(bloco.tipo);
      }
      
      blocosAnteriores = [...blocosAtuais];
      
    } catch (error) {
      console.error("Erro ao atualizar estatísticas:", error);
    }
  }

  async function registrarAtividadeEstatisticas(tipo) {
    if (!currentUser) return;
    
    try {
      const hoje = new Date().toISOString().split('T')[0];
      
      // Registra atividade individual
      await db.collection("users").doc(currentUser.uid).collection("estatisticas").doc("registros").collection("atividades").add({
        tipo: tipo,
        data: hoje,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      
    } catch (error) {
      console.error("Erro ao registrar atividade:", error);
    }
  }

  async function incrementarEstatistica(tipo) {
    if (!currentUser) return;
    
    try {
      const estatisticasRef = db.collection("users").doc(currentUser.uid).collection("estatisticas").doc("resumo");
      
      await db.runTransaction(async (transaction) => {
        const doc = await transaction.get(estatisticasRef);
        const dados = doc.exists ? doc.data() : {};
        
        const hoje = dados.hoje || {};
        hoje[tipo] = (hoje[tipo] || 0) + 1;
        
        transaction.set(estatisticasRef, { hoje }, { merge: true });
      });
      
    } catch (error) {
      console.error("Erro ao incrementar estatística:", error);
    }
  }

  async function decrementarEstatistica(tipo) {
    if (!currentUser) return;
    
    try {
      const estatisticasRef = db.collection("users").doc(currentUser.uid).collection("estatisticas").doc("resumo");
      
      await db.runTransaction(async (transaction) => {
        const doc = await transaction.get(estatisticasRef);
        const dados = doc.exists ? doc.data() : {};
        
        const hoje = dados.hoje || {};
        hoje[tipo] = Math.max((hoje[tipo] || 0) - 1, 0);
        
        transaction.set(estatisticasRef, { hoje }, { merge: true });
      });
      
    } catch (error) {
      console.error("Erro ao decrementar estatística:", error);
    }
  }

  // --- Funções de Personalização de Cores ---
  function abrirModalCores() {
    // Carrega cores atuais
    document.getElementById('corFoco').value = getComputedStyle(document.documentElement).getPropertyValue('--foco').trim();
    document.getElementById('corEstudo').value = getComputedStyle(document.documentElement).getPropertyValue('--estudo').trim();
    document.getElementById('corDescanso').value = getComputedStyle(document.documentElement).getPropertyValue('--descanso').trim();
    document.getElementById('corAlerta').value = getComputedStyle(document.documentElement).getPropertyValue('--alerta').trim();
    
    atualizarPreviewCores();
    
    // Aplica tema ao modal
    const modalContent = document.querySelector("#modalCores .modal-content");
    if (document.body.classList.contains("dark")) {
      modalContent.classList.add("dark");
    } else {
      modalContent.classList.remove("dark");
    }
    
    document.getElementById('modalCores').style.display = 'block';
  }

  function fecharModalCores() {
    document.getElementById('modalCores').style.display = 'none';
  }

  function atualizarPreviewCores() {
    const tipos = ['Foco', 'Estudo', 'Descanso', 'Alerta'];
    
    tipos.forEach(tipo => {
      const cor = document.getElementById(`cor${tipo}`).value;
      const preview = document.getElementById(`preview${tipo}`);
      const variavel = `--${tipo.toLowerCase()}`;
      
      preview.style.backgroundColor = cor;
      document.documentElement.style.setProperty(variavel, cor);
      localStorage.setItem(variavel, cor);
      
      // Ajusta cor do texto para descanso
      if (tipo === 'Descanso') {
        const luminancia = getLuminancia(cor);
        preview.style.color = luminancia > 0.5 ? '#2e2e2e' : '#ffffff';
      }
    });
  }

  function restaurarCoresPadrao() {
    const coresPadrao = {
      'Foco': '#81C784',
      'Estudo': '#6BAED6', 
      'Descanso': '#F4E06D',
      'Alerta': '#EF9A9A'
    };
    
    Object.entries(coresPadrao).forEach(([tipo, cor]) => {
      document.getElementById(`cor${tipo}`).value = cor;
      const variavel = `--${tipo.toLowerCase()}`;
      document.documentElement.style.setProperty(variavel, cor);
      localStorage.setItem(variavel, cor);
    });
    
    atualizarPreviewCores();
    mostrarNotificacaoSucesso("Cores restauradas para o padrão!");
  }

  function getLuminancia(hex) {
    const r = parseInt(hex.substr(1, 2), 16) / 255;
    const g = parseInt(hex.substr(3, 2), 16) / 255;
    const b = parseInt(hex.substr(5, 2), 16) / 255;
    
    return 0.299 * r + 0.587 * g + 0.114 * b;
  }

  // --- Funções de Notificação ---
  function mostrarNotificacaoSucesso(mensagem) {
    mostrarNotificacaoPopup(mensagem, 'success');
  }

  function mostrarNotificacaoErro(mensagem) {
    mostrarNotificacaoPopup(mensagem, 'error');
  }

  function mostrarNotificacaoPopup(mensagem, tipo) {
    const popup = document.createElement('div');
    popup.className = 'notification-popup';
    popup.style.background = tipo === 'success' ? 'var(--foco)' : 'var(--alerta)';
    popup.textContent = mensagem;
    
    document.body.appendChild(popup);
    
    setTimeout(() => {
      popup.style.opacity = '0';
      popup.style.transform = 'translateX(100px)';
      setTimeout(() => popup.remove(), 300);
    }, 3000);
  }

  // --- Função de Logout ---
  function logout() {
    if (confirm("Tem certeza que deseja sair?")) {
      auth.signOut().then(() => {
        console.log("Logout realizado com sucesso");
        window.location.href = "index.html";
      }).catch((error) => {
        console.error("Erro no logout:", error);
        mostrarNotificacaoErro("Erro ao fazer logout.");
      });
    }
  }

  // --- Event Listeners para Personalização de Cores ---
  document.addEventListener('DOMContentLoaded', function() {
    // Listeners para mudança de cor em tempo real
    ['Foco', 'Estudo', 'Descanso', 'Alerta'].forEach(tipo => {
      const input = document.getElementById(`cor${tipo}`);
      if (input) {
        input.addEventListener('input', atualizarPreviewCores);
      }
    });
  });

  // --- Verificação de Autenticação ---
  auth.onAuthStateChanged(async (user) => {
    const agendaContainer = document.getElementById("agendaContainer");
    const mensagemLogin = document.getElementById("mensagemLogin");
    
    if (user) {
      // Usuário logado
      currentUser = user;
      console.log("Usuário logado:", user.displayName || user.email);
      
      // Mostra a agenda
      mensagemLogin.style.display = "none";
      agendaContainer.style.display = "block";
      
      // Carrega dados
      await carregarAgenda();
      
      // Configura verificação de notificações
      agendaIntervalo = setInterval(verificarAgenda, 60000); // Verifica a cada minuto
      
    } else {
      // Usuário não logado
      currentUser = null;
      
      // Limpa interval se existir
      if (agendaIntervalo) {
        clearInterval(agendaIntervalo);
      }
      
      // Mostra mensagem de login
      agendaContainer.style.display = "none";
      mensagemLogin.style.display = "block";
    }
  });

  // --- Inicialização ---
  document.addEventListener('DOMContentLoaded', function() {
    carregarCoresSalvas();
    
    // Fecha modais ao clicar fora
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });
  });

  // PWA - Registro do Service Worker
  if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
          navigator.serviceWorker.register('/sw.js')
              .then(function(registration) {
                  console.log('Service Worker registrado com sucesso:', registration.scope);
              })
              .catch(function(error) {
                  console.log('Falha ao registrar Service Worker:', error);
              });
      });
  }

</script>

</body>
</html>

