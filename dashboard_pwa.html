<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#81C784"/>
  <meta name="description" content="FocusHue - Sistema Cromático de Foco para organizar seu tempo e aumentar sua produtividade">
  <title>Dashboard - FocusHue</title>
  
  <!-- Manifesto PWA -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Ícones para iOS -->
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167x167.png">
  
  <!-- Splash screens para iOS -->
  <link rel="apple-touch-startup-image" href="icons/splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-1668x2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-1668x2224.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-1536x2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-1242x2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-828x1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  
  <!-- Configurações para iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FocusHue">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>
  
  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- LocalForage para armazenamento offline -->
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  
  <style>
    :root {
      --estudo: #6BAED6;
      --foco: #81C784;
      --descanso: #F4E06D;
      --alerta: #EF9A9A;
      --bg: #d7e3da;
      --text: #2e2e2e;
      --bg-dark: #1c1c1c;
      --text-dark: #eeeeee;
      --card-bg: #ffffff;
      --card-bg-dark: #2c2c2c;
      --card-shadow: 0 4px 12px rgba(0,0,0,0.1);
      --card-shadow-dark: 0 4px 12px rgba(0,0,0,0.3);
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: contain;
    }
    body.dark {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }
    header {
      background: linear-gradient(to right, var(--foco), var(--estudo));
      padding: 20px;
      color: white;
      text-align: center;
      font-size: 1.6rem;
      font-weight: bold;
      position: relative;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .menu-toggle, .theme-toggle {
      position: absolute;
      top: 20px;
      font-size: 1.4rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.3s;
    }
    .menu-toggle:active, .theme-toggle:active {
      background-color: rgba(255,255,255,0.2);
    }
    .menu-toggle { left: 20px; }
    .theme-toggle { right: 20px; }
    nav {
      display: none;
      flex-direction: column;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: absolute;
      top: 70px;
      left: 10px;
      border-radius: 8px;
      padding: 10px;
      z-index: 100;
    }
    body.dark nav {
      background: rgba(40,40,40,0.95);
    }
    nav a {
      padding: 10px;
      text-decoration: none;
      color: #333;
      font-weight: 500;
      border-radius: 5px;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark nav a {
      color: #eee;
    }
    nav a:hover, nav a:active {
      background: var(--foco);
      color: white;
    }
    
    /* Container principal */
    .dashboard-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
    }
    
    /* Seções do Dashboard */
    .dashboard-section {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      transition: box-shadow 0.3s, background-color 0.3s;
    }
    body.dark .dashboard-section {
      background-color: var(--card-bg-dark);
      box-shadow: var(--card-shadow-dark);
    }
    .dashboard-section h2 {
      margin-top: 0;
      font-size: 1.3rem;
      border-bottom: 2px solid var(--foco);
      padding-bottom: 10px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dashboard-section h2 .icon {
      font-size: 1.4rem;
    }
    .dashboard-section .view-all {
      display: block;
      text-align: center;
      margin-top: 15px;
      color: var(--estudo);
      text-decoration: none;
      font-weight: 500;
      padding: 5px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    body.dark .dashboard-section .view-all {
      color: var(--foco);
    }
    .dashboard-section .view-all:hover, .dashboard-section .view-all:active {
      background-color: rgba(0,0,0,0.05);
    }
    body.dark .dashboard-section .view-all:hover, body.dark .dashboard-section .view-all:active {
      background-color: rgba(255,255,255,0.05);
    }
    
    /* Relógio e Modo Atual */
    .clock-section {
      text-align: center;
      padding: 25px 20px;
    }
    .current-time {
      font-size: 3rem;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .current-mode {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 30px;
      font-size: 1.1rem;
      color: white;
      font-weight: 500;
      margin-bottom: 15px;
    }
    .mode-message {
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    /* Próximos Blocos */
    .next-blocks-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .block-item {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .block-item.estudo { background-color: var(--estudo); }
    .block-item.foco { background-color: var(--foco); }
    .block-item.descanso { background-color: var(--descanso); color: #333; }
    .block-item.alerta { background-color: var(--alerta); }
    .block-time {
      font-weight: bold;
    }
    .block-type {
      font-weight: 500;
    }
    
    /* Tarefas Pendentes */
    .tasks-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .task-item {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .task-item.estudo { background-color: var(--estudo); }
    .task-item.foco { background-color: var(--foco); }
    .task-item.descanso { background-color: var(--descanso); color: #333; }
    .task-item.alerta { background-color: var(--alerta); }
    .task-title {
      font-weight: 500;
    }
    
    /* Estatísticas Rápidas */
    .stats-summary {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    .stat-card {
      background-color: rgba(0,0,0,0.05);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    body.dark .stat-card {
      background-color: rgba(255,255,255,0.05);
    }
    .stat-card h3 {
      margin: 0 0 5px 0;
      font-size: 0.9rem;
      opacity: 0.8;
    }
    .stat-card .value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .stat-card.estudo { border-left: 4px solid var(--estudo); }
    .stat-card.foco { border-left: 4px solid var(--foco); }
    .stat-card.descanso { border-left: 4px solid var(--descanso); }
    .stat-card.alerta { border-left: 4px solid var(--alerta); }
    
    /* Gráfico de Pizza */
    .chart-container {
      position: relative;
      height: 180px;
      width: 100%;
    }
    
    /* Mensagem de usuário não logado */
    #mensagemLogin {
      text-align: center;
      margin: 50px auto;
      max-width: 500px;
      padding: 30px;
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      display: none;
    }
    body.dark #mensagemLogin {
      background-color: var(--card-bg-dark);
      box-shadow: var(--card-shadow-dark);
    }
    #mensagemLogin h2 {
      margin-top: 0;
      color: var(--foco);
    }
    #mensagemLogin p {
      font-size: 1.1rem;
      line-height: 1.5;
    }
    #mensagemLogin a {
      display: inline-block;
      margin-top: 15px;
      padding: 10px 20px;
      background-color: var(--foco);
      color: white;
      text-decoration: none;
      border-radius: 5px;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    #mensagemLogin a:hover, #mensagemLogin a:active {
      background-color: var(--estudo);
    }
    
    /* Loader */
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--foco);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }
    body.dark .loader {
      border-color: #333;
      border-top-color: var(--foco);
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Mensagem de status */
    #statusMessage {
      text-align: center;
      margin: 15px auto;
      padding: 10px;
      border-radius: 5px;
      max-width: 600px;
      display: none;
    }
    .success {
      background-color: rgba(129, 199, 132, 0.2);
      color: #2e7d32;
    }
    body.dark .success {
      background-color: rgba(129, 199, 132, 0.1);
      color: #81c784;
    }
    .error {
      background-color: rgba(239, 154, 154, 0.2);
      color: #c62828;
    }
    body.dark .error {
      background-color: rgba(239, 154, 154, 0.1);
      color: #ef9a9a;
    }
    
    /* Mensagem quando não há dados */
    .no-data {
      padding: 15px;
      text-align: center;
      font-style: italic;
      color: #666;
      background-color: rgba(0,0,0,0.05);
      border-radius: 8px;
    }
    body.dark .no-data {
      color: #aaa;
      background-color: rgba(255,255,255,0.05);
    }
    
    /* Botão de instalação do PWA */
    #installPWA {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--foco);
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 24px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      display: none;
      z-index: 1000;
      transition: transform 0.3s, background-color 0.3s;
    }
    #installPWA:hover, #installPWA:active {
      background-color: var(--estudo);
      transform: scale(1.05);
    }
    
    /* Notificação de atualização disponível */
    #updateNotification {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background-color: var(--card-bg);
      color: var(--text);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
      z-index: 1000;
      text-align: center;
    }
    body.dark #updateNotification {
      background-color: var(--card-bg-dark);
      color: var(--text-dark);
    }
    #updateNotification button {
      background-color: var(--foco);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      margin-top: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #updateNotification button:hover, #updateNotification button:active {
      background-color: var(--estudo);
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      .dashboard-container {
        grid-template-columns: 1fr;
      }
      .stats-summary {
        grid-template-columns: repeat(2, 1fr);
      }
      .current-time {
        font-size: 2.5rem;
      }
    }
    
    /* Melhorias para touch */
    @media (hover: none) {
      nav a, .dashboard-section .view-all, #mensagemLogin a {
        padding: 12px;
      }
      .menu-toggle, .theme-toggle {
        padding: 12px;
      }
    }
    
    footer {
      text-align: center;
      padding: 30px 0;
      font-size: 0.9rem;
      color: #999;
    }
    
    /* Animações */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .slide-up {
      animation: slideUp 0.5s ease-out;
    }
  </style>
</head>
<body>
  <header>
    <button class="menu-toggle" onclick="toggleMenu()">☰</button>
    Dashboard FocusHue
    <button class="theme-toggle" onclick="toggleTheme()">🌙</button>
  </header>

  <nav id="menu">
    <a href="index.html">🏠 Início</a>
    <a href="agenda.html">📅 Agenda</a>
    <a href="tarefas.html">✅ Tarefas</a>
    <a href="config.html">⚙️ Configurações</a>
    <a href="estatisticas.html">📊 Estatísticas</a>
    <a href="notificacoes.html">🔔 Notificações</a>
    <a href="#" onclick="logout()">🚪 Sair</a>
  </nav>

  <div id="statusMessage"></div>
  <div class="loader" id="loader"></div>

  <div class="dashboard-container" id="dashboardContainer">
    <!-- Relógio e Modo Atual -->
    <div class="dashboard-section clock-section">
      <div class="current-time" id="currentTime">--:--</div>
      <div class="current-mode" id="currentMode">Carregando...</div>
      <div class="mode-message" id="modeMessage"></div>
    </div>
    
    <!-- Próximos Blocos da Agenda -->
    <div class="dashboard-section">
      <h2><span class="icon">📅</span> Próximos Blocos</h2>
      <div id="nextBlocksContainer">
        <ul class="next-blocks-list" id="nextBlocksList">
          <!-- Blocos serão carregados aqui -->
        </ul>
        <div class="no-data" id="noBlocksMessage" style="display: none;">
          Nenhum bloco agendado para hoje.
        </div>
      </div>
      <a href="agenda.html" class="view-all">Ver agenda completa →</a>
    </div>
    
    <!-- Tarefas Pendentes -->
    <div class="dashboard-section">
      <h2><span class="icon">✅</span> Tarefas Pendentes</h2>
      <div id="tasksContainer">
        <ul class="tasks-list" id="tasksList">
          <!-- Tarefas serão carregadas aqui -->
        </ul>
        <div class="no-data" id="noTasksMessage" style="display: none;">
          Nenhuma tarefa pendente.
        </div>
      </div>
      <a href="tarefas.html" class="view-all">Ver todas as tarefas →</a>
    </div>
    
    <!-- Estatísticas Rápidas -->
    <div class="dashboard-section">
      <h2><span class="icon">📊</span> Estatísticas de Hoje</h2>
      <div id="statsContainer">
        <div class="stats-summary" id="statsSummary">
          <!-- Cards de estatísticas serão carregados aqui -->
        </div>
        <div class="chart-container">
          <canvas id="statsChart"></canvas>
        </div>
        <div class="no-data" id="noStatsMessage" style="display: none;">
          Nenhuma estatística disponível para hoje.
        </div>
      </div>
      <a href="estatisticas.html" class="view-all">Ver estatísticas detalhadas →</a>
    </div>
  </div>

  <div id="mensagemLogin">
    <h2>Bem-vindo ao FocusHue</h2>
    <p>O sistema cromático que ajuda você a organizar seu tempo e aumentar sua produtividade.</p>
    <p>Para acessar seu dashboard personalizado, faça login ou crie uma conta.</p>
    <a href="login.html">Fazer Login</a>
    <a href="cadastro.html" style="margin-left: 10px; background-color: var(--estudo);">Criar Conta</a>
  </div>
  
  <!-- Botão de instalação do PWA -->
  <button id="installPWA" title="Instalar aplicativo">📱</button>
  
  <!-- Notificação de atualização disponível -->
  <div id="updateNotification">
    <p>Uma nova versão do FocusHue está disponível!</p>
    <button id="updateButton">Atualizar agora</button>
  </div>

  <footer>
    © 2025 FocusHue™ — Sistema Cromático de Foco.
  </footer>

  <script>
    // Configuração Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC60NDS13uLBH1Az1EW9sY3eEL8BF80Bxc",
      authDomain: "focushue-16683.firebaseapp.com",
      projectId: "focushue-16683",
      storageBucket: "focushue-16683.appspot.com",
      messagingSenderId: "485935414293",
      appId: "1:485935414293:web:c7ead918246319e0d6a21c"
    };
    
    // Inicialização do Firebase
    try {
      firebase.initializeApp(firebaseConfig);
      console.log("Firebase inicializado com sucesso");
    } catch (error) {
      console.error("Erro ao inicializar Firebase:", error);
      mostrarMensagem("Erro ao inicializar o Firebase. Verifique sua conexão com a internet.", "error");
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    let messaging = null;
    
    // Inicializa o Firebase Messaging se suportado
    if (firebase.messaging.isSupported()) {
      messaging = firebase.messaging();
      
      // Solicita permissão para notificações
      messaging.getToken({ vapidKey: 'BLBz-HJxRLCcBUMJgZZ-JfmZR9dBK9GcQzj9FvGWrQrUHbQnk5MlT-ZurDH6czLRKkbBFEJwkwbJKgbYzUJYV9A' })
        .then((currentToken) => {
          if (currentToken) {
            console.log('Token de notificação obtido:', currentToken);
            // Aqui você pode enviar o token para o servidor
            salvarTokenNoFirestore(currentToken);
          } else {
            console.log('Nenhuma ID de registro disponível. Solicite permissão para gerar um.');
            solicitarPermissaoNotificacao();
          }
        })
        .catch((err) => {
          console.error('Erro ao obter token de notificação:', err);
        });
      
      // Lidar com mensagens em primeiro plano
      messaging.onMessage((payload) => {
        console.log('Mensagem recebida:', payload);
        
        // Exibe notificação mesmo com o app aberto
        if (Notification.permission === 'granted') {
          const notificationTitle = payload.notification.title;
          const notificationOptions = {
            body: payload.notification.body,
            icon: '/icons/icon-192x192.png',
            badge: '/icons/badge-72x72.png',
            vibrate: [100, 50, 100]
          };
          
          // Cria notificação
          const notification = new Notification(notificationTitle, notificationOptions);
          
          // Adiciona evento de clique
          notification.onclick = function() {
            if (payload.data && payload.data.url) {
              window.open(payload.data.url, '_blank');
            }
            notification.close();
          };
        }
      });
    }
    
    let currentUser = null;
    let statsChart = null;
    let clockInterval = null;
    let deferredPrompt = null;
    let newWorker = null;
    
    // Elementos da UI
    const dashboardContainer = document.getElementById('dashboardContainer');
    const mensagemLogin = document.getElementById('mensagemLogin');
    const statusMessage = document.getElementById('statusMessage');
    const loader = document.getElementById('loader');
    const installButton = document.getElementById('installPWA');
    const updateNotification = document.getElementById('updateNotification');
    const updateButton = document.getElementById('updateButton');
    
    // Elementos do relógio e modo atual
    const currentTimeElement = document.getElementById('currentTime');
    const currentModeElement = document.getElementById('currentMode');
    const modeMessageElement = document.getElementById('modeMessage');
    
    // Elementos dos próximos blocos
    const nextBlocksList = document.getElementById('nextBlocksList');
    const noBlocksMessage = document.getElementById('noBlocksMessage');
    
    // Elementos das tarefas
    const tasksList = document.getElementById('tasksList');
    const noTasksMessage = document.getElementById('noTasksMessage');
    
    // Elementos das estatísticas
    const statsSummary = document.getElementById('statsSummary');
    const statsChartCanvas = document.getElementById('statsChart').getContext('2d');
    const noStatsMessage = document.getElementById('noStatsMessage');
    
    // Constantes
    const tiposBloco = ["estudo", "foco", "descanso", "alerta"];
    const coresBloco = ["#6BAED6", "#81C784", "#F4E06D", "#EF9A9A"];
    const labelsBloco = ["Estudo", "Foco", "Descanso", "Alerta"];
    
    // --- Funções de UI e Tema ---
    function toggleMenu() {
      const menu = document.getElementById("menu");
      menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
      
      // Fecha o menu ao clicar fora dele
      if (menu.style.display === "flex") {
        document.addEventListener('click', function closeMenu(e) {
          if (!menu.contains(e.target) && e.target !== document.querySelector('.menu-toggle')) {
            menu.style.display = "none";
            document.removeEventListener('click', closeMenu);
          }
        });
      }
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      
      // Atualiza o ícone do botão
      const themeToggle = document.querySelector(".theme-toggle");
      themeToggle.textContent = isDark ? "☀️" : "🌙";
      
      // Atualiza o gráfico se existir
      if (statsChart) {
        statsChart.options.plugins.legend.labels.color = isDark ? '#eeeeee' : '#2e2e2e';
        statsChart.update();
      }
    }
    
    function carregarCoresSalvas() {
      // Carrega cores personalizadas
      ["--estudo", "--foco", "--descanso", "--alerta"].forEach(variable => {
        const corSalva = localStorage.getItem(variable);
        if (corSalva) document.documentElement.style.setProperty(variable, corSalva);
      });
      
      // Carrega tema claro/escuro
      const tema = localStorage.getItem("theme");
      if (tema === "dark") {
        document.body.classList.add("dark");
        document.querySelector(".theme-toggle").textContent = "☀️";
      } else {
        document.querySelector(".theme-toggle").textContent = "🌙";
      }
    }
    
    function mostrarMensagem(mensagem, tipo) {
      statusMessage.textContent = mensagem;
      statusMessage.className = tipo; // 'success' ou 'error'
      statusMessage.style.display = 'block';
      
      // Esconde a mensagem após 3 segundos
      setTimeout(() => {
        statusMessage.style.display = 'none';
      }, 3000);
    }
    
    function mostrarLoader(mostrar = true) {
      loader.style.display = mostrar ? 'block' : 'none';
    }
    
    function logout() {
      auth.signOut().then(() => {
        console.log("Usuário deslogado com sucesso");
        window.location.href = "login.html";
      }).catch((error) => {
        console.error("Erro ao fazer logout:", error);
        mostrarMensagem("Erro ao fazer logout: " + error.message, "error");
      });
    }
    
    // --- Funções do Relógio e Modo Atual ---
    function atualizarRelogio() {
      const agora = new Date();
      const horas = agora.getHours().toString().padStart(2, '0');
      const minutos = agora.getMinutes().toString().padStart(2, '0');
      const horaAtual = `${horas}:${minutos}`;
      
      currentTimeElement.textContent = horaAtual;
      definirModoAtual(horaAtual);
    }
    
    function definirModoAtual(horaAtual) {
      // Busca blocos da agenda no localStorage ou Firestore
      carregarBlocosDaAgenda().then(blocos => {
        let modoAtual = "produtividade";
        let blocoAtivo = null;
        
        for (let bloco of blocos) {
          if (horaAtual >= bloco.inicio && horaAtual < bloco.fim) {
            modoAtual = bloco.tipo;
            blocoAtivo = bloco;
            break;
          }
        }
        
        // Atualiza a UI com o modo atual
        const nomeExibido = modoAtual.charAt(0).toUpperCase() + modoAtual.slice(1);
        currentModeElement.textContent = nomeExibido;
        currentModeElement.className = `current-mode ${modoAtual}`;
        
        // Atualiza a mensagem
        if (blocoAtivo) {
          modeMessageElement.textContent = `Bloco ativo até ${blocoAtivo.fim}`;
        } else {
          modeMessageElement.textContent = "Nenhum bloco agendado para agora";
        }
      });
    }
    
    // --- Funções de Carregamento de Dados ---
    async function carregarBlocosDaAgenda() {
      if (!currentUser) return [];
      
      try {
        // Tenta carregar do Firestore primeiro
        const docRef = db.collection("users").doc(currentUser.uid).collection("agenda").doc("dia");
        const doc = await docRef.get();
        
        if (doc.exists && doc.data().blocos) {
          return doc.data().blocos;
        }
        
        // Se não encontrar no Firestore, tenta carregar do localStorage
        const blocosLocalStorage = JSON.parse(localStorage.getItem("agenda-dia") || "[]");
        return blocosLocalStorage;
      } catch (error) {
        console.error("Erro ao carregar blocos da agenda:", error);
        // Em caso de erro, tenta carregar do localStorage
        const blocosLocalStorage = JSON.parse(localStorage.getItem("agenda-dia") || "[]");
        return blocosLocalStorage;
      }
    }
    
    async function carregarProximosBlocos() {
      if (!currentUser) return;
      
      try {
        const blocos = await carregarBlocosDaAgenda();
        
        // Filtra apenas os blocos futuros
        const agora = new Date();
        const horaAtual = `${agora.getHours().toString().padStart(2, '0')}:${agora.getMinutes().toString().padStart(2, '0')}`;
        
        const blocosFuturos = blocos.filter(bloco => bloco.inicio > horaAtual)
                                   .sort((a, b) => a.inicio.localeCompare(b.inicio))
                                   .slice(0, 3); // Pega apenas os próximos 3 blocos
        
        // Atualiza a UI
        if (blocosFuturos.length > 0) {
          nextBlocksList.innerHTML = '';
          blocosFuturos.forEach(bloco => {
            const li = document.createElement('li');
            li.className = `block-item ${bloco.tipo} slide-up`;
            li.innerHTML = `
              <span class="block-time">${bloco.inicio} - ${bloco.fim}</span>
              <span class="block-type">${bloco.tipo.charAt(0).toUpperCase() + bloco.tipo.slice(1)}</span>
            `;
            nextBlocksList.appendChild(li);
          });
          nextBlocksList.style.display = 'block';
          noBlocksMessage.style.display = 'none';
        } else {
          nextBlocksList.style.display = 'none';
          noBlocksMessage.style.display = 'block';
        }
      } catch (error) {
        console.error("Erro ao carregar próximos blocos:", error);
        nextBlocksList.style.display = 'none';
        noBlocksMessage.style.display = 'block';
      }
    }
    
    async function carregarTarefasPendentes() {
      if (!currentUser) return;
      
      try {
        // Tenta carregar do Firestore
        const tarefasRef = db.collection("users").doc(currentUser.uid).collection("tarefas");
        const snapshot = await tarefasRef.orderBy("createdAt", "desc").limit(3).get();
        
        if (!snapshot.empty) {
          tasksList.innerHTML = '';
          snapshot.forEach(doc => {
            const tarefa = doc.data();
            const li = document.createElement('li');
            const tipoClass = tarefa.tipo ? tarefa.tipo.toLowerCase() : 'foco';
            li.className = `task-item ${tipoClass} slide-up`;
            li.innerHTML = `
              <span class="task-title">${tarefa.titulo || 'Tarefa sem título'}</span>
              <span class="task-type">${tarefa.tipo || 'Foco'}</span>
            `;
            tasksList.appendChild(li);
          });
          tasksList.style.display = 'block';
          noTasksMessage.style.display = 'none';
        } else {
          // Se não encontrar no Firestore, tenta carregar do localStorage
          const tarefasLocalStorage = JSON.parse(localStorage.getItem("tarefas") || "[]");
          
          if (tarefasLocalStorage.length > 0) {
            tasksList.innerHTML = '';
            tarefasLocalStorage.slice(0, 3).forEach(tarefa => {
              const li = document.createElement('li');
              const tipoClass = tarefa.tipo ? tarefa.tipo.toLowerCase() : 'foco';
              li.className = `task-item ${tipoClass} slide-up`;
              li.innerHTML = `
                <span class="task-title">${tarefa.titulo || 'Tarefa sem título'}</span>
                <span class="task-type">${tarefa.tipo || 'Foco'}</span>
              `;
              tasksList.appendChild(li);
            });
            tasksList.style.display = 'block';
            noTasksMessage.style.display = 'none';
          } else {
            tasksList.style.display = 'none';
            noTasksMessage.style.display = 'block';
          }
        }
      } catch (error) {
        console.error("Erro ao carregar tarefas pendentes:", error);
        
        // Em caso de erro, tenta carregar do localStorage
        const tarefasLocalStorage = JSON.parse(localStorage.getItem("tarefas") || "[]");
        
        if (tarefasLocalStorage.length > 0) {
          tasksList.innerHTML = '';
          tarefasLocalStorage.slice(0, 3).forEach(tarefa => {
            const li = document.createElement('li');
            const tipoClass = tarefa.tipo ? tarefa.tipo.toLowerCase() : 'foco';
            li.className = `task-item ${tipoClass} slide-up`;
            li.innerHTML = `
              <span class="task-title">${tarefa.titulo || 'Tarefa sem título'}</span>
              <span class="task-type">${tarefa.tipo || 'Foco'}</span>
            `;
            tasksList.appendChild(li);
          });
          tasksList.style.display = 'block';
          noTasksMessage.style.display = 'none';
        } else {
          tasksList.style.display = 'none';
          noTasksMessage.style.display = 'block';
        }
      }
    }
    
    async function carregarEstatisticasRapidas() {
      if (!currentUser) return;
      
      try {
        // Tenta carregar do Firestore
        const docRef = db.collection("users").doc(currentUser.uid).collection("estatisticas").doc("resumo");
        const doc = await docRef.get();
        
        if (doc.exists && doc.data().hoje) {
          const dados = doc.data().hoje;
          
          // Atualiza os cards de estatísticas
          statsSummary.innerHTML = '';
          tiposBloco.forEach((tipo, index) => {
            const valor = dados[tipo] || 0;
            const card = document.createElement('div');
            card.className = `stat-card ${tipo} fade-in`;
            card.innerHTML = `
              <h3>${labelsBloco[index]}</h3>
              <div class="value">${valor}</div>
            `;
            statsSummary.appendChild(card);
          });
          
          // Atualiza o gráfico
          renderizarGrafico(dados);
          
          statsSummary.style.display = 'grid';
          document.querySelector('.chart-container').style.display = 'block';
          noStatsMessage.style.display = 'none';
        } else {
          // Se não encontrar no Firestore, tenta carregar do localStorage
          const dadosLocalStorage = JSON.parse(localStorage.getItem("estatisticas-hoje") || "{}");
          
          if (Object.keys(dadosLocalStorage).length > 0) {
            // Atualiza os cards de estatísticas
            statsSummary.innerHTML = '';
            tiposBloco.forEach((tipo, index) => {
              const valor = dadosLocalStorage[tipo] || 0;
              const card = document.createElement('div');
              card.className = `stat-card ${tipo} fade-in`;
              card.innerHTML = `
                <h3>${labelsBloco[index]}</h3>
                <div class="value">${valor}</div>
              `;
              statsSummary.appendChild(card);
            });
            
            // Atualiza o gráfico
            renderizarGrafico(dadosLocalStorage);
            
            statsSummary.style.display = 'grid';
            document.querySelector('.chart-container').style.display = 'block';
            noStatsMessage.style.display = 'none';
          } else {
            statsSummary.style.display = 'none';
            document.querySelector('.chart-container').style.display = 'none';
            noStatsMessage.style.display = 'block';
          }
        }
      } catch (error) {
        console.error("Erro ao carregar estatísticas rápidas:", error);
        
        // Em caso de erro, tenta carregar do localStorage
        const dadosLocalStorage = JSON.parse(localStorage.getItem("estatisticas-hoje") || "{}");
        
        if (Object.keys(dadosLocalStorage).length > 0) {
          // Atualiza os cards de estatísticas
          statsSummary.innerHTML = '';
          tiposBloco.forEach((tipo, index) => {
            const valor = dadosLocalStorage[tipo] || 0;
            const card = document.createElement('div');
            card.className = `stat-card ${tipo} fade-in`;
            card.innerHTML = `
              <h3>${labelsBloco[index]}</h3>
              <div class="value">${valor}</div>
            `;
            statsSummary.appendChild(card);
          });
          
          // Atualiza o gráfico
          renderizarGrafico(dadosLocalStorage);
          
          statsSummary.style.display = 'grid';
          document.querySelector('.chart-container').style.display = 'block';
          noStatsMessage.style.display = 'none';
        } else {
          statsSummary.style.display = 'none';
          document.querySelector('.chart-container').style.display = 'none';
          noStatsMessage.style.display = 'block';
        }
      }
    }
    
    function renderizarGrafico(dados) {
      if (statsChart) statsChart.destroy();
      
      // Extrai os valores dos dados para o formato esperado pelo Chart.js
      const valores = tiposBloco.map(tipo => dados[tipo] || 0);
      
      statsChart = new Chart(statsChartCanvas, {
        type: 'pie',
        data: {
          labels: labelsBloco,
          datasets: [{
            data: valores,
            backgroundColor: coresBloco
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: document.body.classList.contains('dark') ? '#eeeeee' : '#2e2e2e',
                font: {
                  size: 11
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.parsed} blocos`;
                }
              }
            }
          },
          animation: {
            duration: 1000
          }
        }
      });
    }
    
    // --- Funções de PWA ---
    function registrarServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registrado com sucesso:', registration.scope);
            
            // Verifica se há uma nova versão do service worker
            registration.addEventListener('updatefound', () => {
              newWorker = registration.installing;
              
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Há uma nova versão do service worker
                  console.log('Nova versão do Service Worker disponível');
                  mostrarNotificacaoAtualizacao();
                }
              });
            });
          })
          .catch(error => {
            console.error('Erro ao registrar Service Worker:', error);
          });
          
        // Escuta mensagens do service worker
        navigator.serviceWorker.addEventListener('message', event => {
          console.log('Mensagem recebida do Service Worker:', event.data);
          
          if (event.data.type === 'CACHE_UPDATED') {
            console.log('Cache atualizado:', event.data.url);
          }
        });
      }
    }
    
    function mostrarNotificacaoAtualizacao() {
      updateNotification.style.display = 'block';
    }
    
    function atualizarServiceWorker() {
      if (newWorker) {
        newWorker.postMessage({ action: 'skipWaiting' });
      }
      
      // Recarrega a página para usar o novo service worker
      window.location.reload();
    }
    
    function configurarInstalacaoPWA() {
      // Captura o evento beforeinstallprompt
      window.addEventListener('beforeinstallprompt', (e) => {
        // Previne o comportamento padrão
        e.preventDefault();
        // Armazena o evento para uso posterior
        deferredPrompt = e;
        // Mostra o botão de instalação
        installButton.style.display = 'block';
      });
      
      // Configura o botão de instalação
      installButton.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        
        // Mostra o prompt de instalação
        deferredPrompt.prompt();
        
        // Espera pela escolha do usuário
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`Resultado da instalação: ${outcome}`);
        
        // Limpa a referência
        deferredPrompt = null;
        
        // Esconde o botão
        installButton.style.display = 'none';
      });
      
      // Escuta o evento appinstalled
      window.addEventListener('appinstalled', (e) => {
        console.log('PWA instalado com sucesso');
        // Esconde o botão
        installButton.style.display = 'none';
        // Mostra mensagem de sucesso
        mostrarMensagem('FocusHue foi instalado com sucesso!', 'success');
      });
    }
    
    function solicitarPermissaoNotificacao() {
      if (!('Notification' in window)) {
        console.log('Este navegador não suporta notificações');
        return;
      }
      
      if (Notification.permission === 'granted') {
        console.log('Permissão para notificações já concedida');
        return;
      }
      
      if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            console.log('Permissão para notificações concedida');
            
            // Inicializa o Firebase Messaging
            if (messaging) {
              messaging.getToken({ vapidKey: 'BLBz-HJxRLCcBUMJgZZ-JfmZR9dBK9GcQzj9FvGWrQrUHbQnk5MlT-ZurDH6czLRKkbBFEJwkwbJKgbYzUJYV9A' })
                .then(currentToken => {
                  if (currentToken) {
                    console.log('Token de notificação obtido:', currentToken);
                    salvarTokenNoFirestore(currentToken);
                  } else {
                    console.log('Nenhuma ID de registro disponível.');
                  }
                })
                .catch(err => {
                  console.error('Erro ao obter token de notificação:', err);
                });
            }
          } else {
            console.log('Permissão para notificações negada');
          }
        });
      }
    }
    
    async function salvarTokenNoFirestore(token) {
      if (!currentUser) return;
      
      try {
        await db.collection('users').doc(currentUser.uid).collection('tokens').doc('fcm')
          .set({
            token: token,
            platform: 'web',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        
        console.log('Token FCM salvo no Firestore');
      } catch (error) {
        console.error('Erro ao salvar token FCM:', error);
      }
    }
    
    // --- Funções de Inicialização ---
    function inicializarDashboard() {
      if (!currentUser) {
        dashboardContainer.style.display = 'none';
        mensagemLogin.style.display = 'block';
        return;
      }
      
      dashboardContainer.style.display = 'grid';
      mensagemLogin.style.display = 'none';
      
      // Inicia o relógio
      atualizarRelogio();
      if (clockInterval) clearInterval(clockInterval);
      clockInterval = setInterval(atualizarRelogio, 60000); // Atualiza a cada minuto
      
      // Carrega os dados
      mostrarLoader(true);
      
      Promise.all([
        carregarProximosBlocos(),
        carregarTarefasPendentes(),
        carregarEstatisticasRapidas()
      ]).finally(() => {
        mostrarLoader(false);
      });
      
      // Solicita permissão para notificações
      solicitarPermissaoNotificacao();
    }
    
    // --- Listeners e Inicialização ---
    document.addEventListener('DOMContentLoaded', () => {
      carregarCoresSalvas();
      
      // Registra o service worker
      registrarServiceWorker();
      
      // Configura instalação do PWA
      configurarInstalacaoPWA();
      
      // Configura botão de atualização
      updateButton.addEventListener('click', atualizarServiceWorker);
      
      // Verifica autenticação
      auth.onAuthStateChanged(user => {
        currentUser = user;
        inicializarDashboard();
      });
      
      // Fecha o menu ao clicar fora dele
      document.addEventListener('click', function(e) {
        const menu = document.getElementById('menu');
        if (menu.style.display === 'flex' && !menu.contains(e.target) && e.target !== document.querySelector('.menu-toggle')) {
          menu.style.display = 'none';
        }
      });
    });
    
    // Atualiza os dados a cada 5 minutos
    setInterval(() => {
      if (currentUser) {
        carregarProximosBlocos();
        carregarTarefasPendentes();
        carregarEstatisticasRapidas();
      }
    }, 300000); // 5 minutos
    
    // Sincroniza dados quando o navegador fica online
    window.addEventListener('online', () => {
      console.log('Navegador está online');
      if (currentUser && navigator.serviceWorker.controller) {
        // Solicita sincronização de dados
        navigator.serviceWorker.ready.then(registration => {
          registration.sync.register('sync-agenda')
            .then(() => console.log('Sincronização da agenda registrada'))
            .catch(err => console.error('Erro ao registrar sincronização da agenda:', err));
          
          registration.sync.register('sync-tarefas')
            .then(() => console.log('Sincronização de tarefas registrada'))
            .catch(err => console.error('Erro ao registrar sincronização de tarefas:', err));
        });
      }
    });
    
    // Salva dados localmente quando o navegador fica offline
    window.addEventListener('offline', () => {
      console.log('Navegador está offline');
      mostrarMensagem('Você está offline. Algumas funcionalidades podem estar limitadas.', 'error');
    });
  </script>
</body>
</html>
